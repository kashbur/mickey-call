<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Magical Surprise</title>

  <!-- Mobile / iOS optimization -->
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <style>
    :root {
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-left: env(safe-area-inset-left, 0px);
      --safe-right: env(safe-area-inset-right, 0px);
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      background: #000;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      overflow: hidden;
    }

    #app {
      position: fixed;
      inset: 0;
      padding: var(--safe-top) var(--safe-right) var(--safe-bottom) var(--safe-left);
      display: flex;
      align-items: center;
      justify-content: center;
      background: #000;
    }

    .stage {
      position: relative;
      background: #000;
      overflow: hidden;
      border-radius: 16px;
      max-height: 100%;
      max-width: 100%;
    }

    #fullscreenBtn {
      position: absolute;
      top: 16px;
      right: 16px;
      z-index: 5;
      background: rgba(255,255,255,0.15);
      color: #fff;
      border: 1px solid rgba(255,255,255,0.4);
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 0.85rem;
      backdrop-filter: blur(6px);
      cursor: pointer;
    }

    #sparkleCanvas {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      background: transparent;
      pointer-events: none;
      mix-blend-mode: screen;
      z-index: 2;
    }

    @supports (aspect-ratio: 9 / 16) {
      .stage {
        aspect-ratio: 9 / 16;
        height: 100vh;
      }
    }

    @supports not (aspect-ratio: 9 / 16) {
      .stage {
        width: 56.25vh;
        height: 100vh;
      }
    }

    .screen {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1;
      transition: opacity 400ms ease-in-out;
    }

    .screen--hidden {
      opacity: 0;
      pointer-events: none;
    }

    .screen--active {
      opacity: 1;
      pointer-events: auto;
    }

    .desk-bg {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .envelope-img {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 70%;
      height: auto;
    }

    .envelope-glow {
      animation: envelopeGlow 5s ease-out forwards;
    }

    @keyframes envelopeGlow {
      0% {
        filter: drop-shadow(0 0 0px rgba(255, 223, 150, 0));
        -webkit-filter: drop-shadow(0 0 0px rgba(255, 223, 150, 0));
      }
      40% {
        filter: drop-shadow(0 0 10px rgba(255, 223, 150, 0.6));
        -webkit-filter: drop-shadow(0 0 10px rgba(255, 223, 150, 0.6));
      }
      70% {
        filter: drop-shadow(0 0 18px rgba(255, 235, 180, 0.9));
        -webkit-filter: drop-shadow(0 0 18px rgba(255, 235, 180, 0.9));
      }
      100% {
        filter: drop-shadow(0 0 26px rgba(255, 245, 210, 1));
        -webkit-filter: drop-shadow(0 0 26px rgba(255, 245, 210, 1));
      }
    }

    .envelope-text {
      position: absolute;
      left: 17.65%;   /* 190.6px / 1080px */
      top: 30.23%;    /* 580.4px / 1920px */
      transform: translate(0, 0);
      font-size: 1.2rem;
      font-weight: 600;
      color: #3b2b1a;
      text-align: center;
      text-shadow: 0 0 4px rgba(255, 255, 255, 0.7);
      pointer-events: none;
    }

    video {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .overlay {
      position: absolute;
      inset: 0;
      padding: 24px;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      align-items: center;
      pointer-events: none;
      text-align: center;
    }

    .child-name {
      font-size: 1.4rem;
      font-weight: 700;
      color: #fff;
      text-shadow: 0 0 12px rgba(0,0,0,0.8);
      margin-bottom: 4px;
    }

    .small-text {
      font-size: 0.9rem;
      color: #f5f5f5;
      text-shadow: 0 0 8px rgba(0,0,0,0.8);
    }
  </style>
</head>

<body>
  <div id="app">
    <div class="stage">

      <button id="fullscreenBtn">⤢ Full Screen</button>

      <!-- Sparkle canvas overlay -->
      <canvas id="sparkleCanvas"></canvas>

      <!-- Intro screen: Mickey talking -->
      <div id="screen-intro" class="screen screen--active">
        <video id="revealVideo"
               src="mickey-intro.mp4"
               autoplay
               playsinline
               muted>
        </video>

        <div class="overlay">
          <div class="child-name" id="childName"></div>
          <div class="small-text" id="bottomLine"></div>
        </div>
      </div>

      <!-- Envelope screen: desk background + envelope + "To NAME" -->
      <div id="screen-envelope" class="screen screen--hidden">
        <img
          src="desk-background.png"
          alt="Magical desk background"
          class="desk-bg"
        />
        <img
          src="envelope.png"
          alt="Envelope"
          class="envelope-img"
        />
        <div class="envelope-text" id="envelopeToText"></div>
      </div> <!-- end of #screen-envelope -->

      <!-- Mickey tapping screen -->
      <div id="screen-mickey-tap" class="screen screen--hidden">
        <video
          id="mickeyTapVideo"
          src="mickey-tapping.mp4"
          playsinline
          muted
        ></video>
      </div>

      <!-- Envelope magic screen -->
      <div id="screen-envelope-magic" class="screen screen--hidden">
        <video
          id="envelopeMagicVideo"
          src="envelope-magic.mp4"
          playsinline
          muted
        ></video>
      </div>

      <!-- Mickey out window screen -->
      <div id="screen-mickey-outwindow" class="screen screen--hidden">
        <video
          id="mickeyOutVideo"
          src="mickey-outwindow.mp4"
          playsinline
          muted
        ></video>
      </div>

      <!-- Flying houses screen -->
      <div id="screen-flying-houses" class="screen screen--hidden">
        <video
          id="flyingHousesVideo"
          src="flying-houses.mp4"
          playsinline
          muted
        ></video>
      </div>

      <!-- Flying clouds screen -->
      <div id="screen-flying-clouds" class="screen screen--hidden">
        <video
          id="flyingCloudsVideo"
          src="flying-clouds.mp4"
          playsinline
          muted
        ></video>
      </div>

    </div>
  </div>

  <script>
    // Read ?name=, ?line= and ?to=
    const params = new URLSearchParams(window.location.search);
    const name = params.get("name") || "";
    const line = params.get("line") || "";
    const toName = params.get("to") || name || "";

    if (name) document.getElementById("childName").textContent = name;
    if (line) document.getElementById("bottomLine").textContent = line;
    if (toName) {
      const envelopeTextEl = document.getElementById("envelopeToText");
      if (envelopeTextEl) envelopeTextEl.textContent = "To " + toName;
    }

    // iOS autoplay helper
    const video = document.getElementById("revealVideo");
    document.addEventListener("touchstart", () => {
      if (video.paused) video.play().catch(() => {});
    }, { passive: true });

    const introScreen = document.getElementById("screen-intro");
    const envelopeScreen = document.getElementById("screen-envelope");
    const mickeyTapScreen = document.getElementById("screen-mickey-tap");
    const mickeyTapVideo = document.getElementById("mickeyTapVideo");
    let sparklesEnabled = false;
    let magicCharged = false;
    let magicChargeProgress = 0;
    let lastMagicEventTime = null;
    const REQUIRED_MAGIC_MS = 5000;

    const envelopeMagicScreen = document.getElementById("screen-envelope-magic");
    const envelopeMagicVideo = document.getElementById("envelopeMagicVideo");
    const mickeyOutScreen = document.getElementById("screen-mickey-outwindow");
    const mickeyOutVideo = document.getElementById("mickeyOutVideo");
    const flyingHousesScreen = document.getElementById("screen-flying-houses");
    const flyingHousesVideo = document.getElementById("flyingHousesVideo");
    const flyingCloudsScreen = document.getElementById("screen-flying-clouds");
    const flyingCloudsVideo = document.getElementById("flyingCloudsVideo");

    // === MAGIC SPARKLES ENGINE ===
    const MagicSparkles = (() => {
      let canvas, ctx;
      let width = 0, height = 0;
      let particles = [];
      let running = false;

      const defaults = {
        maxParticles: 300,
        hueMin: 40,  // gold-range
        hueMax: 55,
        sizeMin: 2.5,
        sizeMax: 7,
        decayMin: 0.015,
        decayMax: 0.03
      };

      let config = { ...defaults };

      class Particle {
        constructor(x, y) {
          this.x = x;
          this.y = y;
          this.size = rand(config.sizeMin, config.sizeMax);
          this.speedX = rand(-1.2, 1.2);
          this.speedY = rand(-1.2, 1.2);
          this.life = 1;
          this.decay = rand(config.decayMin, config.decayMax);
          this.hue = rand(config.hueMin, config.hueMax);
        }

        update() {
          this.x += this.speedX;
          this.y += this.speedY;
          this.life -= this.decay;
          if (this.size > 0.05) {
            this.size -= 0.05;
          }
        }

        draw() {
          if (this.life <= 0 || this.size <= 0.05) return;
          const alpha = Math.max(this.life, 0);
          const radius = this.size * 4;

          const gradient = ctx.createRadialGradient(
            this.x, this.y, 0,
            this.x, this.y, radius
          );

          gradient.addColorStop(0, `hsla(${this.hue}, 100%, 90%, ${alpha})`);
          gradient.addColorStop(0.3, `hsla(${this.hue}, 100%, 70%, ${alpha * 0.9})`);
          gradient.addColorStop(0.7, `hsla(${this.hue}, 90%, 50%, ${alpha * 0.4})`);
          gradient.addColorStop(1, `hsla(${this.hue}, 90%, 40%, 0)`);

          ctx.beginPath();
          ctx.fillStyle = gradient;
          ctx.arc(this.x, this.y, radius, 0, Math.PI * 2);
          ctx.fill();

          ctx.beginPath();
          ctx.fillStyle = `hsla(${this.hue}, 100%, 95%, ${alpha})`;
          ctx.arc(this.x, this.y, this.size * 0.7, 0, Math.PI * 2);
          ctx.fill();
        }
      }

      function rand(min, max) {
        return Math.random() * (max - min) + min;
      }

      function resize() {
        if (!canvas) return;
        const rect = canvas.getBoundingClientRect();
        const dpr = window.devicePixelRatio || 1;
        width = rect.width;
        height = rect.height;
        canvas.width = width * dpr;
        canvas.height = height * dpr;
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      }

      function burst(x, y, count = 5) {
        if (!canvas) return;
        for (let i = 0; i < count; i++) {
          if (particles.length >= config.maxParticles) break;
          particles.push(new Particle(x, y));
        }
      }

      function step() {
        if (!running || !ctx) return;
        ctx.clearRect(0, 0, width, height);

        for (let i = particles.length - 1; i >= 0; i--) {
          const p = particles[i];
          p.update();
          p.draw();
          if (p.life <= 0 || p.size <= 0.05) {
            particles.splice(i, 1);
          }
        }

        requestAnimationFrame(step);
      }

      function init(selector = "#sparkleCanvas", options = {}) {
        canvas = document.querySelector(selector);
        if (!canvas) {
          console.warn("MagicSparkles: canvas not found", selector);
          return;
        }
        ctx = canvas.getContext("2d");
        config = { ...defaults, ...options };

        resize();
        window.addEventListener("resize", resize);

        if (!running) {
          running = true;
          requestAnimationFrame(step);
        }
      }

      function start() {
        if (!running) {
          running = true;
          requestAnimationFrame(step);
        }
      }

      function stop() {
        running = false;
      }

      function setConfig(options = {}) {
        config = { ...config, ...options };
      }

      return { init, burst, start, stop, setConfig, resize };
    })();

    // Initialize sparkles engine on DOM ready
    document.addEventListener("DOMContentLoaded", () => {
      MagicSparkles.init("#sparkleCanvas", {
        maxParticles: 300,
        hueMin: 40,
        hueMax: 55
      });
    });

    if (video && introScreen && envelopeScreen && mickeyTapScreen) {
      video.addEventListener("ended", () => {
        // Intro → Envelope
        introScreen.classList.remove("screen--active");
        introScreen.classList.add("screen--hidden");
        envelopeScreen.classList.remove("screen--hidden");
        envelopeScreen.classList.add("screen--active");

        // After a pause, Envelope → Mickey tapping
        setTimeout(() => {
          envelopeScreen.classList.remove("screen--active");
          envelopeScreen.classList.add("screen--hidden");
          mickeyTapScreen.classList.remove("screen--hidden");
          mickeyTapScreen.classList.add("screen--active");

          if (mickeyTapVideo) {
            mickeyTapVideo.currentTime = 0;
            mickeyTapVideo.play().catch(() => {});
          }
        }, 5000); // pause length in ms (longer so they can read their name)
      });
    }

    if (mickeyTapVideo && envelopeScreen && mickeyTapScreen) {
      mickeyTapVideo.addEventListener("ended", () => {
        // Mickey tapping → back to envelope; enable interactive sparkles
        mickeyTapScreen.classList.remove("screen--active");
        mickeyTapScreen.classList.add("screen--hidden");
        envelopeScreen.classList.remove("screen--hidden");
        envelopeScreen.classList.add("screen--active");

        // Enable sparkles and reset magic charge progress
        sparklesEnabled = true;
        magicCharged = false;
        magicChargeProgress = 0;
        lastMagicEventTime = null;

        const envelopeImgEl = document.querySelector(".envelope-img");
        if (envelopeImgEl) {
          envelopeImgEl.classList.remove("envelope-glow"); // reset if replayed
          void envelopeImgEl.offsetWidth;
          envelopeImgEl.classList.add("envelope-glow");
        }
      });
    }

    // When the user taps/clicks the envelope after magic is enabled,
    // trigger a big explosive burst and transition to the envelope-magic video.
    const envelopeImg = document.querySelector(".envelope-img");
    if (envelopeImg && envelopeScreen && envelopeMagicScreen && envelopeMagicVideo) {
      envelopeImg.addEventListener("pointerdown", (e) => {
        if (!sparklesEnabled || !magicCharged) return;

        const stage = document.querySelector(".stage");
        if (!stage) return;
        const stageRect = stage.getBoundingClientRect();
        const x = e.clientX - stageRect.left;
        const y = e.clientY - stageRect.top;

        // Extra-explosive magic burst at the touch point
        MagicSparkles.burst(x, y, 80);
        setTimeout(() => MagicSparkles.burst(x, y, 80), 80);
        setTimeout(() => MagicSparkles.burst(x, y, 60), 160);

        // Disable ongoing trail sparkles as we transition
        sparklesEnabled = false;
        magicCharged = false;
        magicChargeProgress = 0;
        lastMagicEventTime = null;

        const envelopeImgEl2 = document.querySelector(".envelope-img");
        if (envelopeImgEl2) {
          envelopeImgEl2.classList.remove("envelope-glow");
        }

        // Short delay to let the explosion show, then switch scenes
        setTimeout(() => {
          envelopeScreen.classList.remove("screen--active");
          envelopeScreen.classList.add("screen--hidden");
          envelopeMagicScreen.classList.remove("screen--hidden");
          envelopeMagicScreen.classList.add("screen--active");

          envelopeMagicVideo.currentTime = 0;
          envelopeMagicVideo.play().catch(() => {});
        }, 200);
      });
    }

    document.addEventListener("pointermove", (e) => {
      if (!sparklesEnabled) return;

      const stage = document.querySelector(".stage");
      const envelopeImg = document.querySelector(".envelope-img");
      if (!stage || !envelopeImg) return;

      const stageRect = stage.getBoundingClientRect();
      const envelopeRect = envelopeImg.getBoundingClientRect();

      // Only sparkle when pointer is over the envelope area
      const overEnvelope =
        e.clientX >= envelopeRect.left &&
        e.clientX <= envelopeRect.right &&
        e.clientY >= envelopeRect.top &&
        e.clientY <= envelopeRect.bottom;

      if (!overEnvelope) return;

      const x = e.clientX - stageRect.left;
      const y = e.clientY - stageRect.top;
      MagicSparkles.burst(x, y, 10);

      // Accumulate magic charge based on active movement over the envelope
      const now = performance.now();
      if (lastMagicEventTime === null) {
        lastMagicEventTime = now;
      }
      const delta = now - lastMagicEventTime;
      lastMagicEventTime = now;

      magicChargeProgress += delta;
      if (magicChargeProgress >= REQUIRED_MAGIC_MS) {
        magicCharged = true;
      }
    });
    if (envelopeMagicVideo && envelopeMagicScreen && mickeyOutScreen) {
      envelopeMagicVideo.addEventListener("ended", () => {
        // Envelope magic → Mickey out window
        envelopeMagicScreen.classList.remove("screen--active");
        envelopeMagicScreen.classList.add("screen--hidden");
        mickeyOutScreen.classList.remove("screen--hidden");
        mickeyOutScreen.classList.add("screen--active");

        if (mickeyOutVideo) {
          mickeyOutVideo.currentTime = 0;
          mickeyOutVideo.play().catch(() => {});
        }
      });
    }

    // Mickey out window → Flying houses
    if (mickeyOutVideo && mickeyOutScreen && flyingHousesScreen) {
      mickeyOutVideo.addEventListener("ended", () => {
        mickeyOutScreen.classList.remove("screen--active");
        mickeyOutScreen.classList.add("screen--hidden");
        flyingHousesScreen.classList.remove("screen--hidden");
        flyingHousesScreen.classList.add("screen--active");

        if (flyingHousesVideo) {
          flyingHousesVideo.currentTime = 0;
          flyingHousesVideo.play().catch(() => {});
        }
      });
    }

    // Flying houses → Flying clouds
    if (flyingHousesVideo && flyingHousesScreen && flyingCloudsScreen) {
      flyingHousesVideo.addEventListener("ended", () => {
        flyingHousesScreen.classList.remove("screen--active");
        flyingHousesScreen.classList.add("screen--hidden");
        flyingCloudsScreen.classList.remove("screen--hidden");
        flyingCloudsScreen.classList.add("screen--active");

        if (flyingCloudsVideo) {
          flyingCloudsVideo.currentTime = 0;
          flyingCloudsVideo.play().catch(() => {});
        }
      });
    }

    const fullscreenBtn = document.getElementById("fullscreenBtn");
    const stageElement = document.querySelector(".stage");

    if (fullscreenBtn && stageElement) {
      fullscreenBtn.addEventListener("click", () => {
        if (document.fullscreenElement) {
          document.exitFullscreen().catch(() => {});
        } else {
          if (stageElement.requestFullscreen) {
            stageElement.requestFullscreen().catch(() => {});
          } else if (stageElement.webkitRequestFullscreen) {
            stageElement.webkitRequestFullscreen();
          }
        }
      });
    }
  </script>
</body>
</html>
